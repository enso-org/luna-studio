machine:
    python:
        version: 3.5.1
    node:
        version: 6.9.4

dependencies:
    pre:
        - sudo apt-get update && sudo apt-get install openssh-client libzmq3-dev supervisor
        - curl -L https://github.com/commercialhaskell/stack/releases/download/v1.3.0/stack-1.3.0-linux-x86_64.tar.gz | tar zx -C /tmp
        - sudo mv /tmp/stack-1.3.0-linux-x86_64/stack /usr/bin
    override:
        - stack build --stack-yaml=build/backend/stack.yaml --only-dependencies --install-ghc --test --fast -j2
        - stack build internals --stack-yaml=nodelab/stack.yaml --only-dependencies --install-ghc --fast -j1
        - npm install -g brunch@1.8.5 bower
        - cd nodelab && stack build nodelab --only-dependencies --install-ghc --test --fast -j1
        - cd nodelab && npm install
        - cd nodelab && bower install --allow-root

    cache_directories:
        - "~/.stack"
        - "~/.ghcjs"
        - "build/backend/.stack-work"
        - "nodelab/.stack-work"
        - "internals/.stack-work"

compile:
    override:
        - stack build --stack-yaml build/backend/stack.yaml --copy-bins --fast --no-run-tests --no-run-benchmarks -j2
        - stack build internals --stack-yaml nodelab/stack.yaml --fast
        - cd nodelab && brunch build
        - python atom_prep.py
        - cd nodelab && tar -cvf frontend.zip atom && mv frontend.zip $CIRCLE_ARTIFACTS
test:
    override:
        - stack build --stack-yaml build/backend/stack.yaml --fast --test
